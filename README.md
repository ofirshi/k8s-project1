# k8s-project1


# minikube:

minikube stop

minikube delete --all=true --purge=true

docker image prune -a -f

minikube start --cpus 4 --memory 8196 --driver vmware

### Modify settings:
minikube config set cpus 4

minikube config set memory 8196

minikube config set disk-size 10240MB

minikube config set WantUpdateNotification false




# rmqp-example create images:

git clone https://github.com/avielb/rmqp-example

cd rmqp-example/

docker-compose build --no-cache --pull --quiet


# Docker login:

docker login --username=<user> --password-stdin <<<'password'


# Tag images and push to docker hub: 


docker image tag rmqp-example_consumer:latest ofirsh11/rmqp-example_consumer:latest

docker image push ofirsh11/rmqp-example_consumer:latest

docker image tag rmqp-example_producer:latest ofirsh11/rmqp-example_producer:latest

docker image push ofirsh11/rmqp-example_producer:latest 



# rabbitmq:
helm repo add bitnami https://charts.bitnami.com/bitnami

helm repo update

helm upgrade --install rabbitmq --set auth.username=admin,auth.password=secretpassword,auth.erlangCookie=secretcookie,metrics.enabled=true,service.type=NodePort bitnami/rabbitmq

## RabbitMQ 
   
Credentials:
    echo "Username      : admin"
    echo "Password      : $(kubectl get secret --namespace default rabbitmq -o jsonpath="{.data.rabbitmq-password}" | base64 -d)"
    echo "ErLang Cookie : $(kubectl get secret --namespace default rabbitmq -o jsonpath="{.data.rabbitmq-erlang-cookie}" | base64 -d)"

Note that the credentials are saved in persistent volume claims and will not be changed upon upgrade or reinstallation unless the persistent volume claim has been deleted. If this is not the first installation of this chart, the credentials may not be valid.
This is applicable when no passwords are set and therefore the random password is autogenerated. In case of using a fixed password, you should specify it when upgrading.
More information about the credentials may be found at https://docs.bitnami.com/general/how-to/troubleshoot-helm-chart-issues/#credential-errors-while-upgrading-chart-releases.

RabbitMQ can be accessed within the cluster on port 5672 at rabbitmq.default.svc.cluster.local

To access for outside the cluster, perform the following steps:

Obtain the NodePort IP and ports:

    export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
    export NODE_PORT_AMQP=$(kubectl get --namespace default -o jsonpath="{.spec.ports[?(@.name=='amqp')].nodePort}" services rabbitmq)
    export NODE_PORT_STATS=$(kubectl get --namespace default -o jsonpath="{.spec.ports[?(@.name=='http-stats')].nodePort}" services rabbitmq)

To Access the RabbitMQ AMQP port:

    echo "URL : amqp://$NODE_IP:$NODE_PORT_AMQP/"

To Access the RabbitMQ Management interface:

    echo "URL : http://$NODE_IP:$NODE_PORT_STATS/"

To access the RabbitMQ Prometheus metrics, get the RabbitMQ Prometheus URL by running:

    kubectl port-forward --namespace default svc/rabbitmq 9419:9419 &
    echo "Prometheus Metrics URL: http://127.0.0.1:9419/metrics"

Then, open the obtained URL in a browser.


If user minikube docker: 
kubectl port-forward --address 0.0.0.0 service/rabbitmq $NODE_PORT_STATS:15672

list of URLS: 
minikube service rabbitmq --url

# Helm Chart:
helm uninstall k8s-project1 --dry-run
                                                    
helm uninstall k8s-project1
                                                    
helm install k8s-project1 . --dry-run

helm upgrade --install k8s-project1 .
